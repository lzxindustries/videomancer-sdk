name: Documentation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  check-docs:
    name: Documentation Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for broken links in markdown
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'

    - name: Install Python dependencies
      run: |
        pip3 install jsonschema toml

    - name: Validate TOML schema
      run: |
        cd tools/toml-validator
        echo "Validating example templates..."
        python3 toml_schema_validator.py ../../examples/templates/template.toml

    - name: Validate example programs
      run: |
        cd tools/toml-validator
        echo "Validating passthru program..."
        python3 toml_schema_validator.py ../../programs/passthru/passthru.toml
        echo "Validating yuv_amplifier program..."
        python3 toml_schema_validator.py ../../programs/yuv_amplifier/yuv_amplifier.toml

    - name: Check for trailing whitespace
      run: |
        ! git grep -I --line-number --perl-regexp '\s+$' -- '*.md' '*.cpp' '*.hpp' '*.py' '*.sh' '*.toml' || \
        (echo "Found trailing whitespace in the above files" && exit 1)

    - name: Check file permissions
      run: |
        echo "Checking for executable permissions on scripts..."
        if [ ! -x "build_sdk.sh" ]; then echo "build_sdk.sh not executable"; exit 1; fi
        if [ ! -x "build_programs.sh" ]; then echo "build_programs.sh not executable"; exit 1; fi
        if [ ! -x "clean.sh" ]; then echo "clean.sh not executable"; exit 1; fi
        if [ ! -x "tests/run_tests.sh" ]; then echo "tests/run_tests.sh not executable"; exit 1; fi
        echo "All required scripts are executable"

    - name: Documentation summary
      run: |
        echo "## Documentation Status" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Markdown links valid" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ TOML schemas valid" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ No trailing whitespace" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Script permissions correct" >> $GITHUB_STEP_SUMMARY
